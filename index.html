<script>
    // Load products from inventory.json
    fetch('/inventory.json')
        .then(response => response.json())
        .then(products => {
            const productContainer = document.getElementById('product-container');
            productContainer.innerHTML = '';
            Object.values(products).forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'bg-white p-4 rounded shadow';
                productCard.innerHTML = `
                    <img src="${product.image || 'https://via.placeholder.com/300'}" alt="${product.name}" class="w-full h-48 object-cover mb-4">
                    <h3 class="text-lg font-bold">${product.name}</h3>
                    <p class="text-gray-600">$${product.price.toFixed(2)}</p>
                    <button class="bg-green-600 text-white px-4 py-2 mt-2 rounded hover:bg-green-700" onclick="addToCart('${product.id}', '${product.name}', ${product.price})">Add to Cart</button>
                `;
                productContainer.appendChild(productCard);
            });
        })
        .catch(error => console.error('Error loading products:', error));

    // Cart management
    let cartItems = JSON.parse(localStorage.getItem('cartItems') || '[]');
    const cartCount = document.getElementById('cart-count');
    const cartItemsContainer = document.getElementById('cart-items');
    const cartTotal = document.getElementById('cart-total');

    function updateCart() {
        cartCount.textContent = cartItems.length;
        cartItemsContainer.innerHTML = '';
        let total = 0;
        cartItems.forEach(item => {
            total += item.price * item.quantity;
            const cartItem = document.createElement('div');
            cartItem.className = 'flex justify-between items-center mb-2';
            cartItem.innerHTML = `
                <span>${item.name} (x${item.quantity})</span>
                <span>$${(item.price * item.quantity).toFixed(2)}</span>
            `;
            cartItemsContainer.appendChild(cartItem);
        });
        cartTotal.textContent = total.toFixed(2);
        localStorage.setItem('cartItems', JSON.stringify(cartItems));
    }

    function addToCart(id, name, price) {
        const existingItem = cartItems.find(item => item.id === id);
        if (existingItem) {
            existingItem.quantity += 1;
        } else {
            cartItems.push({ id, name, price, quantity: 1 });
        }
        updateCart();
    }

    // Checkout
    document.getElementById('checkout-button').addEventListener('click', async () => {
        const cartItems = JSON.parse(localStorage.getItem('cartItems') || '[]');
        if (cartItems.length === 0) {
            alert('Your cart is empty!');
            return;
        }
        try {
            const response = await fetch('/api/create-checkout-session', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ items: cartItems })
            });
            const data = await response.json();
            if (!response.ok) {
                throw new Error(data.error || `HTTP error! Status: ${response.status}`);
            }
            const stripe = Stripe('pk_test_51Rn5OUKHOkbIJcHXZLhS6WVMYnxVG6WABeRoJiQdF1LrH8ccfweIGOARLby8vSeFsAi06ZKxgO1cCCdhChHEDy9Q00LCRnDv10');
            await stripe.redirectToCheckout({ sessionId: data.id });
        } catch (error) {
            console.error('Checkout error:', error.message);
            alert(`Failed to proceed to checkout: ${error.message}. Please try again.`);
        }
    });

    // Initialize cart
    updateCart();
</script>

